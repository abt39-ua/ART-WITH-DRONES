<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado del Mapa</title>
    <!-- Enlace a tu hoja de estilos CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Encabezado de la p치gina -->
    <header>
        <h1>游댠 Estado del Mapa 游댠</h1>
    </header>

    <!-- Contenido principal -->
    <main>
        <!-- Mapa interactivo (puedes reemplazar esto con tu implementaci칩n espec칤fica) -->
        <div id="map">
            <!-- Celdas generadas din치micamente -->
            <!-- Modifica este bloque para agregar las celdas -->
            <!-- Puedes usar JavaScript para generarlas din치micamente -->
            <!-- Aqu칤 se muestra un ejemplo est치tico para un tablero vac칤o -->
            <!-- Repite el patr칩n seg칰n el tama침o del tablero -->
            <!-- Aseg칰rate de ajustar seg칰n tus necesidades -->
            <!-- Fin del ejemplo -->
        </div>
        
        <!-- Informaci칩n relacionada con los drones -->
        <div id="">
            <!-- Puedes agregar m치s informaci칩n aqu칤 seg칰n tus necesidades -->
        </div>
    </main>

    <!-- Pie de p치gina -->
    <footer>
        <p>&copy; 2023 Estado del Mapa</p>
    </footer>

    <script>
        // Selecciona el elemento con el id 'map'
        const mapElement = document.getElementById('map');
    
        // Crea una fila adicional para mostrar solo las etiquetas de las columnas
        const columnHeader = document.createElement('div');
        columnHeader.className = 'row header-row';
        
        // Bucle para las filas (se agrega una fila adicional)
        for (let j = 0; j < 21; j++) {
            const cellElement = document.createElement('div');
    
            if (j === 0){
                // Muestra un hueco para j igual a 0
                cellElement.className = 'cell row-header empty';
                cellElement.innerText = " ";
            }
            else{
                cellElement.className = 'cell row-header';
                cellElement.innerText = `${j}`;
            }


            columnHeader.appendChild(cellElement);
        }

        // Agrega la fila de etiquetas de columna al mapa (se agrega una fila adicional)
        mapElement.appendChild(columnHeader);
        
        // Bucle externo para las filas
        for (let i = 0; i < 20; i++) {
            // Crea un nuevo elemento div para representar la fila
            const rowElement = document.createElement('div');
            rowElement.className = 'row'; // Asigna la clase 'row'
    
            // Crea una celda para la etiqueta de la fila
            const rowHeader = document.createElement('div');
            rowHeader.className = 'cell header-cell row-header';
            rowHeader.innerText = `${i + 1}`;
    
            // Agrega la celda de etiqueta de fila a la fila
            rowElement.appendChild(rowHeader);
    
            // Bucle interno para las columnas
            for (let j = 0; j < 20; j++) {
                // Crea un nuevo elemento div para representar la celda
                const cellElement = document.createElement('div');
                cellElement.className = 'cell'; // Asigna la clase 'cell'

                // Especifica un ancho m칤nimo para la celda
                cellElement.style.minWidth = "50px"; // Puedes ajustar este valor seg칰n tus necesidades

                // Agrega la celda a la fila
                rowElement.appendChild(cellElement);
            }
    
            // Agrega la fila al tablero
            mapElement.appendChild(rowElement);
        }

        function checkAllDronesInMap(drones) {
            for (const droneId in drones) {
                if (drones.hasOwnProperty(droneId)) {
                if (!drones[droneId].estado) {
                    return false;  // If any drone's estado is false, return false immediately
                }
                }
            }
            return true;  // If we reach this point, it means all drones have estado set to true
        }
        
        // Variable para rastrear si el mensaje ya se mostr칩
        let figuraCompletadaMostrada = false;

        function actualizarInterfaz() {

            // Borra el contenido existente del mapa
            const mapElement = document.getElementById('map');
            const cells = document.querySelectorAll('#map .row:not(.header-row) .cell:not(.row-header)');
            // Limpiar el contenido de todas las celdas
            cells.forEach(cell => {
                cell.innerText = ""; // Vaciar la celda
                cell.style.backgroundColor = 'white';
            });
            //mapElement.innerHTML = "";
            
            // Hacer una solicitud GET al endpoint '/estado_mapa'
            fetch('http://127.0.0.1:5000/estado_mapa')
                .then(response => response.json())
                .then(data => {
                    const drones = data;
                    completada = checkAllDronesInMap(drones);

                    if(completada){
                        if (!figuraCompletadaMostrada) {
                            // Crear un contenedor para centrar el mensaje
                            const centerContainer = document.createElement('div');
                            centerContainer.style.textAlign = 'center';
                            centerContainer.style.marginTop = '20px';  // Ajusta el espacio en la parte superior seg칰n sea necesario

                            // Mostrar el mensaje solo si no se ha mostrado antes
                            const completionMessage = document.createElement('div');
                            completionMessage.innerText = "춰FIGURA COMPLETADA!";
                            completionMessage.style.fontSize = "3em";
                            completionMessage.style.color = "black";
                            completionMessage.style.backgroundColor = "gold";  // Fondo dorado
                            completionMessage.style.padding = "10px";
                            completionMessage.style.display = "inline-block";  // Hacer que el fondo se ajuste al texto
                            completionMessage.className = 'completion-message';  // Clase para identificaci칩n y eliminaci칩n posterior
                            
                            // Agregar el mensaje al contenedor centrado
                            centerContainer.appendChild(completionMessage);
                            
                            mapElement.parentNode.insertBefore(centerContainer, mapElement.nextSibling);

                            // Establecer la variable para indicar que el mensaje se ha mostrado
                            figuraCompletadaMostrada = true;
                        }
                    
                        } else {
                            // La figura ya no est치 completada, verificar y eliminar el mensaje si est치 presente
                            const completionMessage = document.querySelector('.completion-message');
                            if (completionMessage) {
                                completionMessage.parentNode.removeChild(completionMessage);
                                // Restablecer la variable para indicar que el mensaje se ha eliminado
                                figuraCompletadaMostrada = false;
                            }
                        }

                    // Crear un objeto para rastrear las celdas y los drones en cada celda
                    const cells = {};

                    // Iterar sobre el diccionario de drones y actualizar la interfaz
                    for (const droneId in drones) {
                        if (drones.hasOwnProperty(droneId)) {
                            const {alias, posicion_x, posicion_y, estado} = drones[droneId];
                            const cellKey = `${posicion_x}-${posicion_y}-${estado}`;

                            // Verificar si la celda ya tiene drones
                            if (cells[cellKey]) {
                                // Agregar el nuevo nombre de dron a la lista de nombres en la celda
                                cells[cellKey].push(droneId);
                            } else {
                                // Crear una nueva lista con el nombre del dron
                                cells[cellKey] = [droneId];
                            }
                        }
                    }

                    // Actualizar la interfaz con los nombres de los drones en las celdas correspondientes
                    for (const cellKey in cells) {
                        if (cells.hasOwnProperty(cellKey)) {
                            const [x, y, estado] = cellKey.split('-').map(Number);
                            const cell = mapElement.querySelector(`.row:nth-child(${y + 2}) .cell:nth-child(${x + 2})`);
                            if (cell) {
                                let cellColor = "green";  // Assume initially that the cell color is green
                                for (const droneId of cells[cellKey]) {
                                    if (!drones[droneId].estado) {
                                        cellColor = "red";  // If any drone in the cell does not have a true state, set cell color to red
                                        break;  // Exit the loop, since we already know the cell color should be red
                                    }
                                }
                                cell.style.backgroundColor = cellColor;  // Set the background color of the cell based on the calculated cellColor
                                cell.innerText = cells[cellKey].join(', ');
                                cell.style.color = "white";
                            }
                        }
                    }
                    
                })
                .catch(error => console.error('Error:', error));
        }

        function ejecutarBucle() {
            // Ejecutar la funci칩n inicialmente
            actualizarInterfaz();

            // Establecer un tiempo de espera antes de la siguiente ejecuci칩n
            setTimeout(ejecutarBucle, 2000); // 2000 milisegundos = 2 segundos
        }

        // Iniciar el bucle
        ejecutarBucle();

        
    </script>
    

</body>
</html>